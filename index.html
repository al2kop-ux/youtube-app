<!DOCTYPE html>
<html lang="en" class="h-full">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Script Outline Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* HTML-rendered output styles */
        #outputDiv h2 {
            font-size: 1.25rem;
            /* text-xl */
            font-weight: 600;
            /* semibold */
            margin-top: 1.5rem;
            /* mt-6 */
            margin-bottom: 0.5rem;
            /* mb-2 */
            border-bottom: 1px solid #4b5563;
            /* border-b border-gray-600 */
            padding-bottom: 0.25rem;
            /* pb-1 */
        }

        #outputDiv h3 {
            font-size: 1.125rem;
            /* text-lg */
            font-weight: 600;
            /* semibold */
            margin-top: 1rem;
            /* mt-4 */
            margin-bottom: 0.5rem;
            /* mb-2 */
            color: #d1d5db;
            /* text-gray-300 */
        }

        #outputDiv p {
            margin-bottom: 0.75rem;
            /* mb-3 */
            line-height: 1.6;
        }

        #outputDiv ul {
            list-style-type: disc;
            margin-left: 1.5rem;
            /* ml-6 */
            margin-bottom: 0.75rem;
            /* mb-3 */
        }

        #outputDiv li {
            margin-bottom: 0.25rem;
            /* mb-1 */
        }

        #outputDiv strong {
            color: #f3f4f6;
            /* text-gray-100 */
            font-weight: 600;
        }

        #outputDiv em,
        #outputDiv i {
            color: #9ca3af;
            /* text-gray-400 */
            font-style: italic;
        }


        /* Loader */
        .loader {
            border-top-color: #3498db;
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
        }

        @-webkit-keyframes spin {
            0% {
                -webkit-transform: rotate(0deg);
            }

            100% {
                -webkit-transform: rotate(360deg);
            }
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Scrollbar styles */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1f2937;
            /* gray-800 */
        }

        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            /* gray-600 */
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
            /* gray-500 */
        }

        /* Modal */
        .modal {
            display: none;
            /* Hidden by default */
            position: fixed;
            /* Stay in place */
            z-index: 50;
            /* Sit on top */
            left: 0;
            top: 0;
            width: 100%;
            /* Full width */
            height: 100%;
            /* Full height */
            overflow: auto;
            /* Enable scroll if needed */
            background-color: rgba(0, 0, 0, 0.6);
            /* Black w/ opacity */
            padding-top: 60px;
        }

        .modal-content {
            background-color: #1f2937;
            /* gray-800 */
            margin: 5% auto;
            /* 5% from the top and centered */
            padding: 20px;
            border: 1px solid #4b5563;
            /* gray-600 */
            width: 80%;
            /* Could be more or less, depending on screen size */
            max-width: 800px;
            border-radius: 0.5rem;
            /* rounded-lg */
        }
    </style>
</head>

<body class="h-full bg-gray-900 text-gray-200">
    <div class="flex flex-col h-screen">
        <!-- Header -->
        <header class="bg-gray-800 border-b border-gray-700 shadow-lg">
            <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
                <div class="flex h-16 items-center justify-between">
                    <div class="flex items-center">
                        <svg class="h-8 w-8 text-blue-400" xmlns="http://www.w3.org/2000/svg" fill="none"
                            viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M10.8 1.816A12 12 0 0121.6 10.8c0 1.558-.298 3.036-.832 4.398m-6.758 6.758A12 12 0 0110.8 21.6c-1.558 0-3.036-.298-4.398-.832m-6.758-6.758A12 12 0 012.4 10.8c0-1.558.298-3.036.832-4.398m6.758-6.758A12 12 0 0110.8 2.4c1.558 0 3.036.298 4.398.832M10.8 12a1.5 1.5 0 113 0 1.5 1.5 0 01-3 0zm0 0c0 1.147.33 2.186.87 3.046m-3.046.87a1.5 1.5 0 110-3 1.5 1.5 0 010 3zm3.046.87c.86.54 1.899.87 3.046.87a1.5 1.5 0 110-3 1.5 1.5 0 010 3zm3.046.87a1.5 1.5 0 110-3 1.5 1.5 0 010 3z" />
                        </svg>
                        <h1 class="text-xl font-bold ml-2">YouTube Script Outline Generator</h1>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 overflow-hidden">
            <div class="h-full grid grid-cols-1 lg:grid-cols-2 gap-4 p-4 lg:gap-8 lg:p-8">
                <!-- Left Column (Input) -->
                <div class="h-full flex flex-col space-y-4 overflow-y-auto">
                    <!-- Search Section -->
                    <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
                        <h2 class="text-lg font-semibold mb-3">1. Find Competitor Videos</h2>
                        <div class="flex space-x-2">
                            <input type="text" id="searchInput"
                                class="flex-1 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="Search YouTube by keyword (e.g., 'best pos systems')">
                            <button id="searchButton"
                                class="bg-blue-600 text-white px-4 py-2 rounded-md font-medium hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-800">
                                Search
                            </button>
                        </div>
                    </div>

                    <!-- Input Section -->
                    <div class="bg-gray-800 p-4 rounded-lg border border-gray-700 flex-1 flex flex-col">
                        <h2 class="text-lg font-semibold mb-3">2. Configure Your Script</h2>
                        <div class="flex-1 flex flex-col space-y-4">
                            <!-- Topic -->
                            <div>
                                <label for="topicInput" class="block text-sm font-medium text-gray-300 mb-1">Video
                                    Topic</label>
                                <input type="text" id="topicInput"
                                    class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="Enter your video topic (e.g., 'How to Open a Liquor Store')">
                            </div>

                            <!-- Persona -->
                            <div>
                                <label for="personaSelect" class="block text-sm font-medium text-gray-300 mb-1">Select
                                    Persona</label>
                                <select id="personaSelect"
                                    class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="default" selected>Default / None</option>
                                    <option value="korona">Michael - KORONA POS</option>
                                    <option value="verticulate">Mihkel - Verticulate</option>
                                </select>
                            </div>

                            <!-- How-To Guide -->
                            <details class="bg-gray-700 p-3 rounded-md">
                                <summary class="cursor-pointer text-sm font-medium text-gray-300">How to get YouTube
                                    transcripts</summary>
                                <ol class="list-decimal list-inside text-sm text-gray-400 mt-2 space-y-1">
                                    <li>Open a YouTube video.</li>
                                    <li>Click the "..." (three dots) button below the video player.</li>
                                    <li>Click "Show transcript".</li>
                                    <li>Copy the text from the transcript box that appears.</li>
                                    <li>Paste it into one of the fields below.</li>
                                </ol>
                            </details>

                            <!-- Transcript URL Inputs -->
                            <div class="flex-1 grid grid-cols-1 gap-4">
                                <div>
                                    <label for="sourceInput1"
                                        class="block text-sm font-medium text-gray-300 mb-1">Source URL
                                        1</label>
                                    <div class="flex space-x-2">
                                        <input type="url" id="sourceInput1"
                                            class="flex-1 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                            placeholder="Paste YouTube video URL 1">
                                        <button data-target="sourceInput1"
                                            class="showTranscriptBtn bg-gray-600 text-white px-3 py-2 rounded-md font-medium text-sm hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            Show Transcript
                                        </button>
                                    </div>
                                </div>
                                <div>
                                    <label for="sourceInput2"
                                        class="block text-sm font-medium text-gray-300 mb-1">Source URL
                                        2</label>
                                    <div class="flex space-x-2">
                                        <input type="url" id="sourceInput2"
                                            class="flex-1 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                            placeholder="Paste YouTube video URL 2">
                                        <button data-target="sourceInput2"
                                            class="showTranscriptBtn bg-gray-600 text-white px-3 py-2 rounded-md font-medium text-sm hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            Show Transcript
                                        </button>
                                    </div>
                                </div>
                                <div>
                                    <label for="sourceInput3"
                                        class="block text-sm font-medium text-gray-300 mb-1">Source URL
                                        3</label>
                                    <div class="flex space-x-2">
                                        <input type="url" id="sourceInput3"
                                            class="flex-1 bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                            placeholder="Paste YouTube video URL 3">
                                        <button data-target="sourceInput3"
                                            class="showTranscriptBtn bg-gray-600 text-white px-3 py-2 rounded-md font-medium text-sm hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            Show Transcript
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Error Box -->
                        <div id="errorBox"
                            class="hidden bg-red-800 border border-red-700 text-red-100 px-4 py-3 rounded-md mt-4">
                            <strong class="font-bold">Error:</strong>
                            <span id="errorMessage" class="block sm:inline">Something went wrong.</span>
                        </div>

                        <!-- Generate Button -->
                        <button id="generateButton"
                            class="w-full bg-blue-600 text-white px-4 py-3 rounded-md font-semibold text-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-800 mt-6">
                            Generate Script Outline
                        </button>
                    </div>
                </div>

                <!-- Right Column (Output) -->
                <div id="outputContainer"
                    class="h-full bg-gray-800 border border-gray-700 rounded-lg flex flex-col overflow-hidden relative">
                    <!-- Output Header -->
                    <div class="flex justify-between items-center p-4 border-b border-gray-700">
                        <h2 class="text-lg font-semibold">Generated Outline</h2>
                        <button id="copyButton"
                            class="bg-gray-600 text-white px-4 py-2 rounded-md font-medium text-sm hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            Copy to Clipboard
                        </button>
                    </div>
                    <!-- Loader -->
                    <div id="loader"
                        class="hidden absolute inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-10">
                        <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-500 h-12 w-12">
                        </div>
                    </div>
                    <!-- Placeholder -->
                    <div id="placeholder"
                        class="flex-1 flex flex-col items-center justify-center text-center text-gray-500 p-8">
                        <svg class="h-16 w-16 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                            stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
                        </svg>
                        <h3 class="text-lg font-semibold">Your script outline will appear here</h3>
                        <p class="text-sm">Enter a topic and any source URLs, then click "Generate Script Outline" to
                            begin.</p>
                    </div>
                    <!-- Output Content -->
                    <div id="outputDiv" class="flex-1 overflow-y-auto p-6" style="display: none;">
                        <!-- Rich text will be rendered here -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Transcript Modal -->
    <div id="transcriptModal" class="modal">
        <div class="modal-content flex flex-col" style="height: 70vh;">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-100">Video Transcript</h2>
                <button id="closeModalBtn" class="text-gray-400 hover:text-white text-3xl">&times;</button>
            </div>
            <textarea id="modalTextarea" readonly
                class="flex-1 w-full bg-gray-900 text-gray-300 border border-gray-600 rounded-md p-3 resize-none focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
            <button id="copyModalBtn"
                class="mt-4 bg-blue-600 text-white px-4 py-2 rounded-md font-medium hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-800">
                Copy Transcript
            </button>
        </div>
    </div>

    <!-- Search Modal -->
    <div id="searchModal" class="modal">
        <div class="modal-content flex flex-col" style="height: 70vh;">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-100">YouTube Search Results</h2>
                <button id="closeSearchModalBtn" class="text-gray-400 hover:text-white text-3xl">&times;</button>
            </div>
            <div id="searchModalContent" class="flex-1 overflow-y-auto space-y-3">
                <!-- Search results will be injected here -->
            </div>
        </div>
    </div>


    <script type="module">
        // --- API URLs ---
        const generateApiUrl = `/api/generate`;
        const fetchTranscriptApiUrl = `/api/fetch-transcript`;
        const searchApiUrl = `/api/search-youtube`; // New API endpoint

        // --- Element Selectors ---
        const topicInput = document.getElementById('topicInput');
        const personaSelect = document.getElementById('personaSelect');
        const sourceInput1 = document.getElementById('sourceInput1');
        const sourceInput2 = document.getElementById('sourceInput2');
        const sourceInput3 = document.getElementById('sourceInput3');
        const generateButton = document.getElementById('generateButton');
        const outputContainer = document.getElementById('outputContainer');
        const outputDiv = document.getElementById('outputDiv');
        const loader = document.getElementById('loader');
        const placeholder = document.getElementById('placeholder');
        const copyButton = document.getElementById('copyButton');
        const errorBox = document.getElementById('errorBox');
        const errorMessage = document.getElementById('errorMessage');

        // Transcript Modal
        const transcriptModal = document.getElementById('transcriptModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const modalTextarea = document.getElementById('modalTextarea');
        const copyModalBtn = document.getElementById('copyModalBtn');

        // --- NEW: Search Modal Elements ---
        const searchInput = document.getElementById('searchInput');
        const searchButton = document.getElementById('searchButton');
        const searchModal = document.getElementById('searchModal');
        const closeSearchModalBtn = document.getElementById('closeSearchModalBtn');
        const searchModalContent = document.getElementById('searchModalContent');

        // --- State ---
        let currentModalTarget = null; // To know which input to fill

        // --- Local Storage ---
        const saveState = () => {
            localStorage.setItem('youtubeScriptGeneratorState', JSON.stringify({
                topic: topicInput.value,
                persona: personaSelect.value,
                url1: sourceInput1.value,
                url2: sourceInput2.value,
                url3: sourceInput3.value,
                output: outputDiv.innerHTML
            }));
        };

        const loadState = () => {
            const state = JSON.parse(localStorage.getItem('youtubeScriptGeneratorState'));
            if (state) {
                topicInput.value = state.topic || '';
                personaSelect.value = state.persona || 'default';
                sourceInput1.value = state.url1 || '';
                sourceInput2.value = state.url2 || '';
                sourceInput3.value = state.url3 || '';
                if (state.output) {
                    outputDiv.innerHTML = state.output;
                    outputDiv.style.display = 'block';
                    placeholder.style.display = 'none';
                }
            }
        };

        // --- Error Handling ---
        const showError = (message) => {
            errorMessage.textContent = message;
            errorBox.classList.remove('hidden');
            loader.classList.add('hidden');
            generateButton.disabled = false;
        };

        const clearError = () => {
            errorBox.classList.add('hidden');
        };

        // --- Transcript Modal Functions ---
        const openTranscriptModal = () => transcriptModal.style.display = 'block';
        const closeTranscriptModal = () => transcriptModal.style.display = 'none';

        document.querySelectorAll('.showTranscriptBtn').forEach(button => {
            button.addEventListener('click', async (e) => {
                clearError();
                const targetInputId = e.target.dataset.target;
                currentModalTarget = document.getElementById(targetInputId);
                const url = currentModalTarget.value;

                if (!url) {
                    showError("Please paste a YouTube URL first.");
                    return;
                }

                modalTextarea.value = "Fetching transcript...";
                openTranscriptModal();

                try {
                    const response = await fetch(fetchTranscriptApiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ url: url })
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.error || 'Could not fetch transcript');
                    }

                    modalTextarea.value = data.transcript;

                } catch (err) {
                    modalTextarea.value = `Error: ${err.message}`;
                    // Also show error in main UI
                    showError(err.message);
                }
            });
        });

        closeModalBtn.onclick = closeTranscriptModal;
        window.onclick = (event) => {
            if (event.target == transcriptModal) {
                closeTranscriptModal();
            }
            if (event.target == searchModal) {
                closeSearchModal();
            }
        };

        copyModalBtn.addEventListener('click', () => {
            modalTextarea.select();
            document.execCommand('copy');
            copyModalBtn.textContent = 'Copied!';
            setTimeout(() => { copyModalBtn.textContent = 'Copy Transcript'; }, 2000);
        });


        // --- NEW: Search Modal Functions ---
        const openSearchModal = () => searchModal.style.display = 'block';
        const closeSearchModal = () => searchModal.style.display = 'none';

        searchButton.addEventListener('click', async () => {
            clearError();
            const query = searchInput.value;
            if (!query) {
                showError("Please enter a search keyword.");
                return;
            }

            searchModalContent.innerHTML = `<div class="flex items-center justify-center h-full">
                <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-500 h-12 w-12"></div>
            </div>`;
            openSearchModal();

            try {
                const response = await fetch(searchApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: query })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Could not fetch search results');
                }

                displaySearchResults(data.videos);

            } catch (err) {
                searchModalContent.innerHTML = `<p class="text-red-400">Error: ${err.message}</p>`;
                showError(err.message);
            }
        });

        const displaySearchResults = (videos) => {
            searchModalContent.innerHTML = ''; // Clear loader
            if (videos.length === 0) {
                searchModalContent.innerHTML = '<p>No results found.</p>';
                return;
            }

            videos.forEach(video => {
                const videoEl = document.createElement('div');
                videoEl.className = 'flex items-start space-x-3 p-3 bg-gray-700 rounded-lg';
                videoEl.innerHTML = `
                    <img src="${video.thumbnail}" alt="Thumbnail" class="w-24 h-14 rounded-md object-cover">
                    <div class="flex-1">
                        <h4 class="font-semibold text-sm text-gray-100">${video.title}</h4>
                        <p class="text-xs text-gray-400 mb-2">${video.channel}</p>
                        <button data-url="https://www.youtube.com/watch?v=${video.videoId}" 
                                class="use-video-btn bg-blue-600 text-white px-3 py-1 rounded-md text-xs font-medium hover:bg-blue-700">
                            Use This Video
                        </button>
                    </div>
                `;
                searchModalContent.appendChild(videoEl);
            });
        };

        // Add event listener for "Use This Video" buttons (delegation)
        searchModalContent.addEventListener('click', (e) => {
            if (e.target.classList.contains('use-video-btn')) {
                const url = e.target.dataset.url;
                if (!sourceInput1.value) {
                    sourceInput1.value = url;
                } else if (!sourceInput2.value) {
                    sourceInput2.value = url;
                } else if (!sourceInput3.value) {
                    sourceInput3.value = url;
                } else {
                    sourceInput1.value = url; // Overwrite first one
                }
                closeSearchModal();
            }
        });

        closeSearchModalBtn.onclick = closeSearchModal;


        // --- Main Generate Function ---
        generateButton.addEventListener('click', async () => {
            clearError();
            const topic = topicInput.value;
            const persona = personaSelect.value;
            const url1 = sourceInput1.value;
            const url2 = sourceInput2.value;
            const url3 = sourceInput3.value;

            if (!topic) {
                showError("Video topic is required.");
                return;
            }

            // Show loader and hide placeholder
            loader.classList.remove('hidden');
            placeholder.style.display = 'none';
            outputDiv.style.display = 'none';
            generateButton.disabled = true;

            try {
                const response = await fetch(generateApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        topic: topic,
                        persona: persona,
                        urls: [url1, url2, url3].filter(url => url) // Send only non-empty URLs
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    // Check if the error from the server is JSON
                    let errorMsg = "An unknown error occurred.";
                    try {
                        const errData = await response.json(); // Try parsing error
                        errorMsg = errData.error || JSON.stringify(errData);
                    } catch (e) {
                        errorMsg = data.error || "Failed to generate outline. The server returned a non-JSON error.";
                    }
                    throw new Error(errorMsg);
                }

                // We expect the text to be in data.candidates[0].content.parts[0].text
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text;

                if (!text) {
                    throw new Error("Received an empty response from the AI. Check the serverless function logs.");
                }

                outputDiv.innerHTML = text; // Render the HTML
                outputDiv.style.display = 'block';
                saveState(); // Save the new output

            } catch (err) {
                let errorDetails = err.message;
                try {
                    // If error message is a JSON string, parse it for better display
                    const parsedError = JSON.parse(err.message);
                    errorDetails = parsedError.error || err.message;
                } catch (e) {
                    // not a JSON string, just show it
                }
                showError(errorDetails);
            } finally {
                // Hide loader and re-enable button
                loader.classList.add('hidden');
                generateButton.disabled = false;
            }
        });

        // --- Copy Button ---
        copyButton.addEventListener('click', () => {
            // Create a temporary, invisible element
            const tempEl = document.createElement('div');
            // Set styles to make it "clean" (no dark background)
            tempEl.style.position = 'absolute';
            tempEl.style.left = '-9999px';
            tempEl.style.color = '#000000'; // Black text
            tempEl.style.backgroundColor = '#ffffff'; // White background
            tempEl.innerHTML = outputDiv.innerHTML; // Copy the rich HTML
            document.body.appendChild(tempEl);

            // Select the content of the temporary element
            const range = document.createRange();
            range.selectNode(tempEl);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);

            try {
                // Execute the copy command
                document.execCommand('copy');
                copyButton.textContent = 'Copied!';
            } catch (err) {
                console.error('Failed to copy rich text: ', err);
                // Fallback to plain text copy
                const plainText = outputDiv.innerText;
                const fallbackTextArea = document.createElement('textarea');
                fallbackTextArea.value = plainText;
                document.body.appendChild(fallbackTextArea);
                fallbackTextArea.select();
                document.execCommand('copy');
                document.body.removeChild(fallbackTextArea);
                copyButton.textContent = 'Copied (Plain Text)!';
            }

            // Clean up
            document.body.removeChild(tempEl);
            window.getSelection().removeAllRanges();

            setTimeout(() => {
                copyButton.textContent = 'Copy to Clipboard';
            }, 2000);
        });


        // --- Event Listeners for saving state ---
        topicInput.addEventListener('input', saveState);
        personaSelect.addEventListener('change', saveState);
        sourceInput1.addEventListener('input', saveState);
        sourceInput2.addEventListener('input', saveState);
        sourceInput3.addEventListener('input', saveState);

        // --- Initial Load ---
        loadState();

    </script>
</body>

</html>

