<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-900">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Script Outline Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Added styles for rich text output */
        #outputDiv h2 {
            font-size: 1.5rem; /* 24px */
            font-weight: 600;
            color: white;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            border-bottom: 1px solid #4b5563; /* gray-600 */
            padding-bottom: 0.5rem;
        }
        #outputDiv h2:first-child {
            margin-top: 0;
        }
        #outputDiv h3 {
            font-size: 1.25rem; /* 20px */
            font-weight: 600;
            color: #d1d5db; /* gray-300 */
            margin-top: 1.25rem;
            margin-bottom: 0.5rem;
        }
        #outputDiv p {
            margin-bottom: 1rem;
            line-height: 1.6;
        }
        #outputDiv ul {
            list-style-type: disc;
            padding-left: 2rem;
            margin-bottom: 1rem;
        }
        #outputDiv li {
            margin-bottom: 0.5rem;
        }
        #outputDiv strong {
            color: #93c5fd; /* blue-300 */
            font-weight: 600;
        }
        #outputDiv em, #outputDiv i {
            color: #a5b4fc; /* indigo-300 */
            font-style: italic;
        }
        
        /* Styles for the new transcript modal */
        #transcriptModal {
            transition: opacity 0.25s ease-in-out;
        }
        .modal-content {
            max-height: 70vh;
        }
    </style>
</head>
<body class="h-full text-gray-200">
    <div class="flex flex-col md:flex-row h-full">

        <!-- Left Column: Inputs -->
        <div class="w-full md:w-1/2 p-6 md:p-8 bg-gray-800 flex flex-col h-full overflow-y-auto">
            <header class="mb-6">
                <h1 class="text-3xl font-bold text-white mb-2">YouTube Script Outline Generator</h1>
                <p class="text-lg text-gray-400">Enter your topic and source material to generate a script outline in the required format.</p>
            </header>

            <!-- Input Fields -->
            <div class="flex-grow flex flex-col space-y-6">
                <div>
                    <label for="topicInput" class="block text-sm font-medium text-gray-300 mb-2">Video Topic</label>
                    <input type="text" id="topicInput" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="e.g., Best POS systems for small business">
                </div>

                <!-- === PERSONA DROPDOWN === -->
                <div>
                    <label for="personaSelect" class="block text-sm font-medium text-gray-300 mb-2">Trust Intro Persona</label>
                    <select id="personaSelect" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                        <option value="default">Default / None</option>
                        <option value="korona">Michael - KORONA POS</option>
                        <option value="verticulate">Mihkel - Verticulate</option>
                    </select>
                </div>
                
                <!-- === UPDATED: URL Inputs === -->
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-300">YouTube Video URLs</label>
                    <p class="text-xs text-gray-400">Paste full YouTube video URLs below. The app will fetch the transcripts automatically.</p>
                </div>

                <div class="flex-grow flex flex-col space-y-4">
                    <!-- URL Input 1 -->
                    <div>
                        <label for="sourceInput1" class="block text-xs font-medium text-gray-400 mb-1">YouTube URL 1</label>
                        <div class="flex space-x-2">
                            <input type="url" id="sourceInput1" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="https://www.youtube.com/watch?v=...">
                            <button class="showTranscriptBtn bg-gray-600 text-gray-300 px-3 rounded-lg hover:bg-gray-500 text-sm" data-target="sourceInput1">Show</button>
                        </div>
                    </div>
                     <!-- URL Input 2 -->
                    <div>
                        <label for="sourceInput2" class="block text-xs font-medium text-gray-400 mb-1">YouTube URL 2 (Optional)</label>
                        <div class="flex space-x-2">
                            <input type="url" id="sourceInput2" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="https://www.youtube.com/watch?v=...">
                            <button class="showTranscriptBtn bg-gray-600 text-gray-300 px-3 rounded-lg hover:bg-gray-500 text-sm" data-target="sourceInput2">Show</button>
                        </div>
                    </div>
                     <!-- URL Input 3 -->
                    <div>
                        <label for="sourceInput3" class="block text-xs font-medium text-gray-400 mb-1">YouTube URL 3 (Optional)</label>
                        <div class="flex space-x-2">
                            <input type="url" id="sourceInput3" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="https://www.youtube.com/watch?v=...">
                            <button class="showTranscriptBtn bg-gray-600 text-gray-300 px-3 rounded-lg hover:bg-gray-500 text-sm" data-target="sourceInput3">Show</button>
                        </div>
                    </div>
                </div>
                <!-- === END UPDATED INPUTS === -->

                <button id="generateButton" class="w-full bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-blue-700 transition duration-300 ease-in-out flex items-center justify-center space-x-2 disabled:bg-gray-500">
                    <span>Generate Outline</span>
                </button>
            </div>
        </div>

        <!-- Right Column: Output -->
        <div class="w-full md:w-1/2 p-6 md:p-8 bg-gray-900 h-full flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-semibold text-white">Generated Outline</h2>
                <button id="copyButton" class="bg-gray-700 text-gray-300 font-medium py-2 px-4 rounded-lg hover:bg-gray-600 transition duration-300 ease-in-out hidden">
                    Copy to Clipboard
                </button>
            </div>
            <div id="loader" class="flex-grow flex items-center justify-center hidden">
                <div class="loader"></div>
            </div>
            <div id="outputContainer" class="flex-grow h-full overflow-y-auto bg-gray-800 rounded-lg p-6 border border-gray-700 hidden">
                <div id="outputDiv" class="text-white w-full"></div>
            </div>
            <div id="placeholder" class="flex-grow flex items-center justify-center h-full bg-gray-800 rounded-lg border border-gray-700 border-dashed">
                <p class="text-gray-500">Your script outline will appear here...</p>
            </div>
            <div id="errorBox" class="mt-4 p-4 bg-red-900 border border-red-700 text-red-200 rounded-lg hidden">
                <strong>Error:</strong> <span id="errorMessage"></span>
            </div>
        </div>
    </div>

    <!-- === NEW: Transcript Modal === -->
    <div id="transcriptModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-2xl">
            <div class="flex justify-between items-center p-4 border-b border-gray-700">
                <h3 class="text-lg font-semibold text-white">Fetched Transcript</h3>
                <button id="closeModalBtn" class="text-gray-400 hover:text-white">&times;</button>
            </div>
            <div class="p-4 modal-content overflow-y-auto">
                <textarea id="modalTextarea" class="w-full h-96 bg-gray-900 text-gray-300 p-3 rounded border border-gray-700"></textarea>
            </div>
            <div class="p-4 border-t border-gray-700 text-right">
                <button id="copyModalBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 text-sm">Copy to Clipboard</button>
            </div>
        </div>
    </div>
    <!-- === END MODAL === -->


    <script>
        const topicInput = document.getElementById('topicInput');
        const personaSelect = document.getElementById('personaSelect');
        const sourceInput1 = document.getElementById('sourceInput1');
        const sourceInput2 = document.getElementById('sourceInput2');
        const sourceInput3 = document.getElementById('sourceInput3');
        const generateButton = document.getElementById('generateButton');
        const outputContainer = document.getElementById('outputContainer');
        const outputDiv = document.getElementById('outputDiv');
        const loader = document.getElementById('loader');
        const placeholder = document.getElementById('placeholder');
        const copyButton = document.getElementById('copyButton');
        const errorBox = document.getElementById('errorBox');
        const errorMessage = document.getElementById('errorMessage');

        // Modal Elements
        const transcriptModal = document.getElementById('transcriptModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const modalTextarea = document.getElementById('modalTextarea');
        const copyModalBtn = document.getElementById('copyModalBtn');

        // --- UPDATED: Load from localStorage on page load ---
        window.addEventListener('DOMContentLoaded', () => {
            topicInput.value = localStorage.getItem('ytGenerator_topic') || '';
            personaSelect.value = localStorage.getItem('ytGenerator_persona') || 'default';
            // Load URLs instead of text
            sourceInput1.value = localStorage.getItem('ytGenerator_source1') || '';
            sourceInput2.value = localStorage.getItem('ytGenerator_source2') || '';
            sourceInput3.value = localStorage.getItem('ytGenerator_source3') || '';

            const savedOutput = localStorage.getItem('ytGenerator_output');
            if (savedOutput) {
                outputDiv.innerHTML = savedOutput;
                outputContainer.classList.remove('hidden');
                copyButton.classList.remove('hidden');
                placeholder.classList.add('hidden');
            }
        });

        // --- UPDATED: Save inputs to localStorage as user types ---
        topicInput.addEventListener('input', () => localStorage.setItem('ytGenerator_topic', topicInput.value));
        personaSelect.addEventListener('change', () => localStorage.setItem('ytGenerator_persona', personaSelect.value));
        sourceInput1.addEventListener('input', () => localStorage.setItem('ytGenerator_source1', sourceInput1.value));
        sourceInput2.addEventListener('input', () => localStorage.setItem('ytGenerator_source2', sourceInput2.value));
        sourceInput3.addEventListener('input', () => localStorage.setItem('ytGenerator_source3', sourceInput3.value));

        // API URLs
        const generateApiUrl = `/.netlify/functions/generate`; 
        const fetchTranscriptApiUrl = `/.netlify/functions/fetch-transcript`; 

        generateButton.addEventListener('click', async () => {
            const topic = topicInput.value;
            const persona = personaSelect.value;
            
            // Get the URLs
            const url1 = sourceInput1.value;
            const url2 = sourceInput2.value;
            const url3 = sourceInput3.value;

            if (!topic) {
                showError("Please enter a Video Topic.");
                return;
            }
            if (!url1 && !url2 && !url3) {
                showError("Please provide at least one YouTube URL.");
                return;
            }

            // Show loading state
            loader.classList.remove('hidden');
            placeholder.classList.add('hidden');
            outputContainer.classList.add('hidden');
            copyButton.classList.add('hidden');
            generateButton.disabled = true;
            generateButton.querySelector('span').textContent = 'Generating...';
            errorBox.classList.add('hidden');

            const payload = {
                topic: topic,
                persona: persona,
                url1: url1,
                url2: url2,
                url3: url3
            };

            try {
                const response = await fetch(generateApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload) 
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `API Error ${response.status}`);
                }

                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    outputDiv.innerHTML = text; 
                    localStorage.setItem('ytGenerator_output', text);
                    outputContainer.classList.remove('hidden');
                    copyButton.classList.remove('hidden');
                } else if (result.error) {
                     throw new Error(`API Error: ${result.error.message}`);
                } else {
                    throw new Error("No valid response from API.");
                }

            } catch (err) {
                console.error(err);
                showError(err.message || "An unknown error occurred.");
                placeholder.classList.remove('hidden'); 
            } finally {
                loader.classList.add('hidden');
                generateButton.disabled = false;
                generateButton.querySelector('span').textContent = 'Generate Outline';
            }
        });

        // --- NEW: "Show Transcript" Button Logic ---
        document.querySelectorAll('.showTranscriptBtn').forEach(button => {
            button.addEventListener('click', async (e) => {
                const targetInputId = e.target.dataset.target;
                const input = document.getElementById(targetInputId);
                const url = input.value;
                if (!url) {
                    showError("Please paste a YouTube URL first.");
                    return;
                }

                const originalBtnText = e.target.textContent;
                e.target.textContent = '...';
                e.target.disabled = true;

                try {
                    const response = await fetch(fetchTranscriptApiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ url: url })
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Failed to fetch transcript');
                    }

                    const data = await response.json();
                    modalTextarea.value = data.transcript;
                    openModal();

                } catch (err) {
                    showError(err.message);
                } finally {
                    e.target.textContent = originalBtnText;
                    e.target.disabled = false;
                }
            });
        });

        function openModal() {
            transcriptModal.classList.remove('hidden');
            setTimeout(() => transcriptModal.classList.remove('opacity-0'), 10);
        }

        function closeModal() {
            transcriptModal.classList.add('opacity-0');
            setTimeout(() => transcriptModal.classList.add('hidden'), 250);
        }

        closeModalBtn.addEventListener('click', closeModal);

        copyModalBtn.addEventListener('click', () => {
            modalTextarea.select();
            document.execCommand('copy');
            copyModalBtn.textContent = 'Copied!';
            setTimeout(() => copyModalBtn.textContent = 'Copy to Clipboard', 2000);
        });
        
        // --- END: Modal Logic ---


        copyButton.addEventListener('click', () => {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = outputDiv.innerHTML;
            tempDiv.style.position = 'absolute';
            tempDiv.style.left = '-9999px';
            tempDiv.style.color = '#000000';
            tempDiv.style.backgroundColor = '#FFFFFF';
            document.body.appendChild(tempDiv);
            const range = document.createRange();
            range.selectNodeContents(tempDiv);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyButton.textContent = 'Copied!';
            } catch (err) {
                console.error('Failed to copy rich text: ', err);
                copyButton.textContent = 'Copy Failed';
            }
            selection.removeAllRanges();
            document.body.removeChild(tempDiv);
            setTimeout(() => {
                copyButton.textContent = 'Copy to Clipboard';
            }, 2000);
        });
        
        function showError(message) {
            errorMessage.textContent = message;
            errorBox.classList.remove('hidden');
            // Hide error after 5 seconds
            setTimeout(() => errorBox.classList.add('hidden'), 5000);
        }

    </script>
</body>
</html>

