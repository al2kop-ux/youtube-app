<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Script Outline Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --bg-color: #111827;
            --card-color: #1F2937;
            --text-color: #F9FAFB;
            --text-muted: #9CA3AF;
            --accent-color: #4F46E5;
            --accent-hover: #4338CA;
            --error-bg: #440000;
            --error-border: #DC2626;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: var(--bg-color);
        }
        ::-webkit-scrollbar-thumb {
            background: #4B5563;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6B7280;
        }

        input, select, textarea {
            background-color: var(--card-color);
            border: 1px solid #374151;
            color: var(--text-color);
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px var(--accent-color);
        }
        
        .btn {
            background-color: var(--accent-color);
            color: white;
            transition: background-color 0.2s;
            border-radius: 0.375rem; /* rounded-md */
        }
        .btn:hover {
            background-color: var(--accent-hover);
        }
        .btn-secondary {
            background-color: #374151;
        }
        .btn-secondary:hover {
            background-color: #4B5563;
        }

        /* Generated HTML styles */
        #outputDiv h2 {
            font-size: 1.25rem; /* text-xl */
            font-weight: 600; /* font-semibold */
            margin-top: 1.5rem; /* mt-6 */
            margin-bottom: 0.5rem; /* mb-2 */
            border-bottom: 1px solid #374151;
            padding-bottom: 0.25rem; /* pb-1 */
        }
        #outputDiv h3 {
            font-size: 1.125rem; /* text-lg */
            font-weight: 600; /* font-semibold */
            margin-top: 1rem; /* mt-4 */
            margin-bottom: 0.25rem; /* mb-1 */
            color: #D1D5DB; /* text-gray-300 */
        }
        #outputDiv p {
            margin-bottom: 0.5rem; /* mb-2 */
            line-height: 1.6;
        }
        #outputDiv ul {
            list-style-type: disc;
            margin-left: 1.5rem; /* ml-6 */
            margin-bottom: 0.5rem; /* mb-2 */
        }
        #outputDiv li {
            margin-bottom: 0.25rem; /* mb-1 */
        }
        #outputDiv em {
            color: var(--text-muted);
        }
        #outputDiv strong {
             color: #E5E7EB; /* text-gray-200 */
        }

        /* Modal Styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed;
            z-index: 50;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.6);
            align-items: center;
            justify-content: center;
        }

        /* Search Results Styles */
        .search-item {
            border-bottom: 1px solid #374151;
            transition: background-color 0.2s;
        }
        .search-item:hover {
            background-color: #374151;
        }
        .search-item img {
            width: 120px;
            height: 68px;
            object-fit: cover;
            border-radius: 0.25rem;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body class="p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
        <h1 class="text-3xl font-bold text-center mb-8">YouTube Script Outline Generator</h1>

        <!-- Error Box -->
        <div id="errorBox" class="hidden bg-red-900/50 border border-red-700 text-red-200 px-4 py-3 rounded-md relative mb-6" role="alert">
            <strong class="font-bold">Error: </strong>
            <span class="block sm:inline" id="errorMessage"></span>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Left Column: Inputs -->
            <div class="space-y-6">
                <h2 class="text-2xl font-semibold border-b border-gray-700 pb-2">1. Inputs</h2>

                <!-- YouTube Search -->
                <div>
                    <label for="searchInput" class="block text-sm font-medium text-gray-300 mb-2">Search YouTube for inspiration:</label>
                    <div class="flex space-x-2">
                        <input type="text" id="searchInput" placeholder="E.g., 'best POS systems for small business'" class="w-full px-3 py-2 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <button id="searchButton" class="px-4 py-2 btn font-semibold">Search</button>
                    </div>
                </div>

                <div>
                    <label for="topicInput" class="block text-sm font-medium text-gray-300 mb-2">Video Topic (Required)</label>
                    <input type="text" id="topicInput" placeholder="E.g., 'Best POS Systems for Small Business'" class="w-full px-3 py-2 rounded-md">
                </div>

                <div>
                    <label for="personaSelect" class="block text-sm font-medium text-gray-300 mb-2">Select Persona</label>
                    <select id="personaSelect" class="w-full px-3 py-2 rounded-md">
                        <option value="default">Default (Generic Expert)</option>
                        <option value="michael-korona">Michael - Korona</option>
                        <option value="mike-verticulate">Mike - Verticulate</option>
                    </select>
                </div>

                <!-- YouTube URLs -->
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-sm font-medium text-gray-300">YouTube URLs (Optional)</label>
                        <button id="howToBtn" class="text-xs text-indigo-400 hover:text-indigo-300">How to get transcript?</button>
                    </div>
                    <p id="howToText" class="hidden text-xs text-gray-400 mb-3 p-3 bg-gray-900 rounded-md">
                        1. Open a YouTube video.<br>
                        2. Click the '...' (More) button below the video.<br>
                        3. Click 'Show transcript'.<br>
                        4. Copy the video's URL (from the browser address bar) and paste it below.
                    </p>
                    <div class="space-y-3">
                        <div class="flex space-x-2">
                            <input type="text" id="sourceInput1" placeholder="https://www.youtube.com/watch?v=..." class="w-full px-3 py-2 rounded-md">
                            <button class="showTranscriptBtn px-3 py-2 btn-secondary text-xs font-medium whitespace-nowrap" data-target="sourceInput1">Show Transcript</button>
                        </div>
                        <div class="flex space-x-2">
                            <input type="text" id="sourceInput2" placeholder="https://www.youtube.com/watch?v=..." class="w-full px-3 py-2 rounded-md">
                            <button class="showTranscriptBtn px-3 py-2 btn-secondary text-xs font-medium whitespace-nowrap" data-target="sourceInput2">Show Transcript</button>
                        </div>
                        <div class="flex space-x-2">
                            <input type="text" id="sourceInput3" placeholder="https://www.youtube.com/watch?v=..." class="w-full px-3 py-2 rounded-md">
                            <button class="showTranscriptBtn px-3 py-2 btn-secondary text-xs font-medium whitespace-nowrap" data-target="sourceInput3">Show Transcript</button>
                        </div>
                    </div>
                </div>

                <button id="generateButton" class="w-full py-3 btn text-lg font-bold">
                    Generate Outline
                </button>
            </div>

            <!-- Right Column: Output -->
            <div class="relative min-h-[400px]">
                <div class="flex justify-between items-center mb-2">
                    <h2 class="text-2xl font-semibold border-b border-gray-700 pb-2">2. Generated Outline</h2>
                    <button id="copyButton" class="px-4 py-2 btn-secondary text-sm font-medium">Copy</button>
                </div>
                
                <div id="outputContainer" class="relative w-full h-[600px] bg-card-color rounded-md border border-gray-700 overflow-auto p-4">
                    <!-- Loader -->
                    <div id="loader" class="hidden absolute inset-0 bg-card-color/80 backdrop-blur-sm flex items-center justify-center">
                        <div class="flex flex-col items-center">
                            <svg class="animate-spin h-8 w-8 text-white mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span class="text-sm text-gray-300">Generating script...</span>
                        </div>
                    </div>
                    <!-- Placeholder -->
                    <div id="placeholder" class="absolute inset-0 flex items-center justify-center">
                        <p class="text-gray-500">Your script outline will appear here...</p>
                    </div>
                    <!-- Output Content -->
                    <div id="outputDiv"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Transcript Modal -->
    <div id="transcriptModal" class="modal">
        <div class="bg-card-color w-full max-w-2xl rounded-lg shadow-xl border border-gray-700 m-4">
            <div class="flex justify-between items-center p-4 border-b border-gray-700">
                <h3 class="text-lg font-semibold">Transcript</h3>
                <button id="closeModalBtn" class="text-gray-400 hover:text-white">&times;</button>
            </div>
            <div class="p-4">
                <textarea id="modalTextarea" class="w-full h-64 p-2 rounded-md" readonly></textarea>
            </div>
            <div class="flex justify-end p-4 border-t border-gray-700">
                <button id="copyModalBtn" class="px-4 py-2 btn font-semibold">Copy Transcript</button>
            </div>
        </div>
    </div>

    <!-- YouTube Search Modal -->
    <div id="searchModal" class="modal">
        <div class="bg-card-color w-full max-w-3xl rounded-lg shadow-xl border border-gray-700 m-4">
            <div class="flex justify-between items-center p-4 border-b border-gray-700">
                <h3 class="text-lg font-semibold">YouTube Search Results</h3>
                <button id="closeSearchModalBtn" class="text-gray-400 hover:text-white">&times;</button>
            </div>
            <div id="searchModalContent" class="p-4 h-[70vh] overflow-y-auto">
                <!-- Results will be injected here -->
            </div>
        </div>
    </div>


    <script>
        // --- API URLs ---
        const generateApiUrl = `/functions/generate`; 
        const fetchTranscriptApiUrl = `/functions/fetch-transcript`; 
        const searchApiUrl = `/functions/search-youtube`;

        // --- Element Selectors ---
        const topicInput = document.getElementById('topicInput');
        const personaSelect = document.getElementById('personaSelect');
        const sourceInput1 = document.getElementById('sourceInput1');
        const sourceInput2 = document.getElementById('sourceInput2');
        const sourceInput3 = document.getElementById('sourceInput3');
        const generateButton = document.getElementById('generateButton');
        const outputContainer = document.getElementById('outputContainer');
        const outputDiv = document.getElementById('outputDiv');
        const loader = document.getElementById('loader');
        const placeholder = document.getElementById('placeholder');
        const copyButton = document.getElementById('copyButton');
        const errorBox = document.getElementById('errorBox');
        const errorMessage = document.getElementById('errorMessage');

        // Transcript Modal
        const transcriptModal = document.getElementById('transcriptModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const modalTextarea = document.getElementById('modalTextarea');
        const copyModalBtn = document.getElementById('copyModalBtn');

        // --- NEW: Search Modal Elements ---
        const searchInput = document.getElementById('searchInput');
        const searchButton = document.getElementById('searchButton');
        const searchModal = document.getElementById('searchModal');
        const closeSearchModalBtn = document.getElementById('closeSearchModalBtn');
        const searchModalContent = document.getElementById('searchModalContent');

        // --- Helper Functions ---
        
        function showError(message) {
            errorMessage.textContent = message;
            errorBox.classList.remove('hidden');
        }

        function clearError() {
            errorBox.classList.add('hidden');
            errorMessage.textContent = '';
        }

        // Universal API Fetch Helper
        async function apiFetch(url, body) {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body),
            });

            if (!response.ok) {
                // Clone the response to safely read it
                const resClone = response.clone();
                let errorMsg = `Error: ${response.status}`;
                try {
                    // Try to parse as JSON first
                    const errJson = await response.json();
                    errorMsg = errJson.error || JSON.stringify(errJson);
                } catch (e) {
                    // If not JSON, try to parse as text
                    try {
                        const errText = await resClone.text();
                        if (errText) {
                            errorMsg = errText;
                        } else {
                            errorMsg = `Error: ${response.status} ${response.statusText}`;
                        }
                    } catch (e2) {
                        // Fallback
                         errorMsg = `Error: ${response.status} ${response.statusText}`;
                    }
                }
                throw new Error(errorMsg);
            }
            return response.json();
        }

        // --- Load from LocalStorage ---
        function loadState() {
            topicInput.value = localStorage.getItem('ytScript_topic') || '';
            personaSelect.value = localStorage.getItem('ytScript_persona') || 'default';
            sourceInput1.value = localStorage.getItem('ytScript_url1') || '';
            sourceInput2.value = localStorage.getItem('ytScript_url2') || '';
            sourceInput3.value = localStorage.getItem('ytScript_url3') || '';
            const savedOutput = localStorage.getItem('ytScript_output');
            if (savedOutput) {
                outputDiv.innerHTML = savedOutput;
                placeholder.classList.add('hidden');
            }
        }

        // --- Save to LocalStorage ---
        function saveState() {
            localStorage.setItem('ytScript_topic', topicInput.value);
            localStorage.setItem('ytScript_persona', personaSelect.value);
            localStorage.setItem('ytScript_url1', sourceInput1.value);
            localStorage.setItem('ytScript_url2', sourceInput2.value);
            localStorage.setItem('ytScript_url3', sourceInput3.value);
        }
        
        function saveOutput() {
             localStorage.setItem('ytScript_output', outputDiv.innerHTML);
        }
        
        // Add listeners to save inputs on change
        topicInput.addEventListener('input', saveState);
        personaSelect.addEventListener('change', saveState);
        sourceInput1.addEventListener('input', saveState);
        sourceInput2.addEventListener('input', saveState);
        sourceInput3.addEventListener('input', saveState);
        
        // --- Generate Button Click ---
        generateButton.addEventListener('click', async () => {
            clearError();
            const topic = topicInput.value;
            if (!topic) {
                showError('Video Topic is required.');
                return;
            }

            loader.classList.remove('hidden');
            placeholder.classList.add('hidden');
            generateButton.disabled = true;

            try {
                const body = {
                    topic: topic,
                    persona: personaSelect.value,
                    url1: sourceInput1.value,
                    url2: sourceInput2.value,
                    url3: sourceInput3.value
                };
                
                const data = await apiFetch(generateApiUrl, body);
                
                const candidate = data.candidates?.[0];
                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const text = candidate.content.parts[0].text;
                    outputDiv.innerHTML = text.replace(/^<div>/, '').replace(/<\/div>$/, ''); // Clean up wrapper
                    saveOutput();
                } else {
                    throw new Error('Invalid response structure from AI.');
                }

            } catch (error) {
                showError(error.message);
                placeholder.classList.remove('hidden');
            } finally {
                loader.classList.add('hidden');
                generateButton.disabled = false;
            }
        });

        // --- Copy Button ---
        copyButton.addEventListener('click', () => {
            try {
                // Create a temporary element to hold the rich text
                const tempEl = document.createElement('div');
                tempEl.innerHTML = outputDiv.innerHTML;
                
                // Set default styles to avoid dark background
                tempEl.style.color = '#000000';
                tempEl.style.backgroundColor = '#ffffff';
                tempEl.style.position = 'absolute';
                tempEl.style.left = '-9999px';
                document.body.appendChild(tempEl);

                // Select the content of the temporary element
                const range = document.createRange();
                range.selectNodeContents(tempEl);
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(range);

                // Copy to clipboard
                document.execCommand('copy');

                // Clean up
                document.body.removeChild(tempEl);
                window.getSelection().removeAllRanges();

                // Show feedback
                copyButton.textContent = 'Copied!';
                setTimeout(() => {
                    copyButton.textContent = 'Copy';
                }, 2000);
            } catch (err) {
                console.error('Failed to copy text: ', err);
                // Fallback for plain text
                navigator.clipboard.writeText(outputDiv.innerText);
                copyButton.textContent = 'Copied (plain)!';
                setTimeout(() => {
                    copyButton.textContent = 'Copy';
                }, 2000);
            }
        });
        
        // --- "How To" Toggle ---
        document.getElementById('howToBtn').addEventListener('click', () => {
            document.getElementById('howToText').classList.toggle('hidden');
        });

        // --- Transcript Modal Logic ---
        document.querySelectorAll('.showTranscriptBtn').forEach(button => {
            button.addEventListener('click', async () => {
                clearError();
                const targetId = button.dataset.target;
                const url = document.getElementById(targetId).value;
                if (!url) {
                    showError('Please paste a YouTube URL first.');
                    return;
                }
                
                modalTextarea.value = 'Fetching transcript...';
                transcriptModal.style.display = 'flex';
                
                try {
                    const data = await apiFetch(fetchTranscriptApiUrl, { url });
                    modalTextarea.value = data.transcript;
                } catch (error) {
                    modalTextarea.value = `Error: ${error.message}`;
                }
            });
        });

        closeModalBtn.addEventListener('click', () => {
            transcriptModal.style.display = 'none';
        });

        copyModalBtn.addEventListener('click', () => {
            modalTextarea.select();
            document.execCommand('copy');
            copyModalBtn.textContent = 'Copied!';
            setTimeout(() => {
                copyModalBtn.textContent = 'Copy Transcript';
            }, 2000);
        });

        // --- YouTube Search Modal Logic ---
        searchButton.addEventListener('click', async () => {
            clearError();
            const query = searchInput.value;
            if (!query) {
                showError('Please enter a search term.');
                return;
            }
            
            searchModalContent.innerHTML = '<p class="text-gray-400">Searching...</p>';
            searchModal.style.display = 'flex';
            
            try {
                const data = await apiFetch(searchApiUrl, { query });
                
                if (data.items && data.items.length > 0) {
                    searchModalContent.innerHTML = ''; // Clear "Searching..."
                    data.items.forEach(item => {
                        const snippet = item.snippet;
                        const videoId = item.id.videoId;
                        const videoUrl = `https://www.youtube.com/watch?v=${videoId}`;
                        
                        const itemEl = document.createElement('div');
                        itemEl.className = 'search-item flex items-start space-x-4 p-3 rounded-md';
                        itemEl.innerHTML = `
                            <img src="${snippet.thumbnails.default.url}" alt="Thumbnail">
                            <div class="flex-1">
                                <h4 class="font-semibold text-sm text-gray-100 mb-1">${snippet.title}</h4>
                                <p class="text-xs text-gray-400 mb-2">${snippet.channelTitle}</p>
                                <button class="use-url-btn text-xs btn px-2 py-1" data-url="${videoUrl}">Use this URL</button>
                            </div>
                        `;
                        searchModalContent.appendChild(itemEl);
                    });
                } else {
                    searchModalContent.innerHTML = '<p class="text-gray-400">No videos found.</p>';
                }

            } catch (error) {
                searchModalContent.innerHTML = `<p class="text-red-400">Error: ${error.message}</p>`;
            }
        });

        closeSearchModalBtn.addEventListener('click', () => {
            searchModal.style.display = 'none';
        });

        // Event delegation for "Use this URL" buttons
        searchModalContent.addEventListener('click', (e) => {
            if (e.target.classList.contains('use-url-btn')) {
                const url = e.target.dataset.url;
                // Find the first empty URL input
                let targetInput = [sourceInput1, sourceInput2, sourceInput3].find(input => !input.value);
                if (targetInput) {
                    targetInput.value = url;
                    saveState();
                    searchModal.style.display = 'none';
                } else {
                    // If all are full, replace the first one
                    sourceInput1.value = url;
                    saveState();
                    searchModal.style.display = 'none';
                }
            }
        });

        // Close modals if clicking outside the content
        window.addEventListener('click', (e) => {
            if (e.target == transcriptModal) {
                transcriptModal.style.display = 'none';
            }
            if (e.target == searchModal) {
                searchModal.style.display = 'none';
            }
        });

        // Load initial state
        loadState();
    </script>
</body>
</html>

